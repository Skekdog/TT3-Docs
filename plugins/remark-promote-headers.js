// This was generated by ChatGPT, sorry!

import { visit } from 'unist-util-visit';

export default function remarkRelativeHeaderPromotion() {
  return (tree) => {
    const lastHeaders = []; // last header at each depth

    visit(tree, 'heading', (node) => {
      const depth = node.depth;

      // Find the nearest less-deep header above this one
      let ancestorDepth = 0;
      for (let i = depth - 1; i > 0; i--) {
        if (lastHeaders[i]) {
          ancestorDepth = i;
          break;
        }
      }

      if (ancestorDepth > 0 && depth > ancestorDepth + 1) {
        // Promote node to be just one level deeper than ancestor
        node.depth = ancestorDepth + 1;
      }

      // Update last header at this depth
      lastHeaders[depth] = node;
      // Clear deeper levels
      for (let i = depth + 1; i < lastHeaders.length; i++) {
        lastHeaders[i] = null;
      }
    });
  };
}
